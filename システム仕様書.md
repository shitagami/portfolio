# BLEビーコンアプリ システム仕様書

## 目次
1. [システム概要](#システム概要)
2. [アーキテクチャ](#アーキテクチャ)
3. [主要ファイルと変数説明](#主要ファイルと変数説明)
4. [データフロー](#データフロー)
5. [主要機能の動作説明](#主要機能の動作説明)

---

## システム概要

### 目的
BLEビーコンを使用して会場の混雑状況を監視し、来場者の行動データを収集・分析するアプリケーションです。

### 主な機能
- **BLEビーコン検出**: 来場者のスマートフォンがビーコンを検出し、位置情報を記録
- **リアルタイム混雑監視**: 各ブースの混雑状況をヒートマップで可視化
- **来場者属性分析**: 年齢、性別、職業、興味分野などの統計分析
- **行動データ分析**: 滞在時間、移動パターン、訪問回数などの分析
- **混雑警報**: 設定した閾値を超えた場合にプッシュ通知を送信
- **複数ロール管理**: 来場者、スタッフ、主催者、出展者の4つのロール

---

## アーキテクチャ

### 技術スタック
- **フレームワーク**: Flutter 3.9+
- **バックエンド**: Firebase (Firestore, Cloud Messaging)
- **BLE通信**: flutter_blue_plus
- **通知**: flutter_local_notifications, firebase_messaging
- **グラフ表示**: fl_chart

### ディレクトリ構造
```
lib/
├── main.dart                    # アプリエントリーポイント
├── firebase_options.dart        # Firebase設定
├── screens/                     # 画面クラス
│   ├── login_screen.dart        # ログイン画面
│   ├── home_screen.dart         # ホーム画面（ビーコン受信）
│   ├── organizer_screen.dart    # 主催者管理画面
│   ├── staff_screen.dart        # スタッフ管理画面
│   ├── exhibitor_screen.dart    # 出展者管理画面
│   └── ...
└── services/                    # サービス層
    ├── auth_service.dart        # 認証サービス
    ├── firebase_service.dart    # Firebase操作サービス
    └── notification_service.dart # 通知サービス
```

---

## 主要ファイルと変数説明

### 1. main.dart

#### 役割
アプリケーションのエントリーポイント。Firebaseと通知サービスの初期化を行う。

#### 主要クラス・変数

**AppStarter (StatefulWidget)**
- `_initialized` (bool): アプリの初期化が完了したかどうか
- `_firebaseInitialized` (bool): Firebaseの初期化が成功したかどうか
- `_initializeApp()`: Firebaseと通知サービスを初期化する非同期メソッド

**MyApp (StatelessWidget)**
- `firebaseInitialized` (bool): Firebase初期化状態を受け取る
- ルーティング設定: 各画面へのナビゲーション定義

#### 動作フロー
1. `main()` → `AppStarter`を起動
2. `_initializeApp()`でFirebaseと通知サービスを初期化
3. 初期化完了後、`MyApp`を表示
4. デフォルトで`OrganizerScreen`を表示（デバッグ用）

---

### 2. services/auth_service.dart

#### 役割
ユーザー認証を管理するシングルトンサービス。

#### 主要クラス・変数

**UserRole (enum)**
- `exhibitor`: 出展者
- `organizer`: 主催者
- `staff`: スタッフ
- `visitor`: 来場者

**AuthService (Singleton)**
- `_currentUserRole` (UserRole?): 現在ログイン中のユーザーロール
- `_currentUserId` (String?): 現在ログイン中のユーザーID
- `_firestore` (FirebaseFirestore): Firestoreインスタンス

#### 主要メソッド
- `loginExhibitor(id, password)`: 出展者ログイン
- `loginOrganizer(id, password)`: 主催者ログイン
- `loginStaff(id, password)`: スタッフログイン
- `loginVisitor()`: 来場者ログイン（簡易版、認証不要）
- `logout()`: ログアウト
- `getUserName()`: 現在のユーザー名を取得

---

### 3. services/firebase_service.dart

#### 役割
Firestoreへのデータ読み書き、ビーコンカウント管理、統計データ取得などを担当。

#### 主要クラス・変数

**FirebaseService**
- `_firestore` (FirebaseFirestore): Firestoreインスタンス
- `_lastProcessedUserBeacon` (Map<String, DateTime>): 重複検出防止用のタイムスタンプ記録
- `_tspExactLimit` (int): TSP（巡回セールスマン問題）の全探索上限（8件）
- `beaconNameMapping` (Map<String, String>): ビーコン物理名からブースIDへのマッピング
- `_defaultRssiThresholds` (Map<String, int>): デフォルトのRSSI閾値

#### 主要メソッド

**ビーコンカウント関連**
- `incrementBeaconCount(deviceName, userId, eventType)`: ビーコン検出時にカウントを増加
  - 重複チェック（5秒以内の同一ユーザー・同一ビーコンはスキップ）
  - 来場者属性情報を取得して記録
  - `beacon_counts/{日付}/devices/{デバイス名}`に保存

- `updateVisitorTimestamp(deviceName, userId, eventType)`: 既存来場者のタイムスタンプのみ更新
  - カウントは増やさず、`lastDetectedAt`と`totalTime`を更新

**統計データ取得**
- `getTodayStats()`: 今日のビーコン受信統計を取得
- `getAllVisitors(targetBoothId)`: 来場者一覧を取得
- `getCompanyAttributeStats()`: 企業属性統計を取得
- `getBoothStayTimeStats()`: ブース別滞在時間統計を取得
- `getMovementPatterns()`: 移動パターンを取得

**ブース管理**
- `getAllBooths()`: 全ブース情報を取得
- `getActiveEventLayout()`: アクティブな展示会レイアウトを取得
- `getMapElements(eventId)`: マップ要素（壁、通路など）を取得

**RSSI閾値管理**
- `getAllBeaconRssiThresholds()`: 全ビーコンのRSSI閾値を取得
- `setBeaconRssiThreshold(beaconName, threshold)`: RSSI閾値を設定
- `watchBeaconRssiThresholds()`: RSSI閾値の変更を監視

**巡回ルート最適化**
- `computeOptimalRoute(targetBoothIds, currentPosition)`: 最適な巡回ルートを計算
  - 8件以下: 全探索で最適解を求める
  - 9件以上: 近傍挿入法 + 2-optで準最適解を求める

**お気に入り管理**
- `getBookmarkedBoothIds(userId)`: お気に入りブース一覧を取得
- `addBoothBookmark(userId, boothId)`: お気に入りに追加
- `removeBoothBookmark(userId, boothId)`: お気に入りから削除

#### データ構造

**beacon_counts/{日付}/devices/{デバイス名}**
```dart
{
  'count': int,                    // 累計訪問数
  'deviceName': string,            // デバイス名
  'firstSeen': Timestamp,          // 初回検出時刻
  'lastSeen': Timestamp,           // 最終検出時刻
  'visitors': [                    // 来場者データ配列
    {
      'userId': string,
      'timestamp': Timestamp,
      'lastDetectedAt': Timestamp,
      'totalTime': int,            // 滞在時間（分）
      'eventType': string,          // "visit" or "long_stay"
      'age': int,
      'gender': string,
      'job': string,
      'company': string,
      'position': string,
      'industry': string,
      'eventSource': string,
      'interests': [string],
    }
  ],
  'isTestData': bool
}
```

---

### 4. services/notification_service.dart

#### 役割
ローカル通知とFCM（Firebase Cloud Messaging）を管理。

#### 主要クラス・変数

**NotificationService (Singleton)**
- `_firebaseMessaging` (FirebaseMessaging): FCMインスタンス
- `_localNotifications` (FlutterLocalNotificationsPlugin): ローカル通知プラグイン
- `_crowdingThreshold` (int): 混雑度の閾値（デフォルト25人）

#### 主要メソッド
- `initialize()`: 通知サービスを初期化
  - 通知権限をリクエスト
  - ローカル通知を初期化
  - FCMを初期化
  - バックグラウンド/フォアグラウンドメッセージハンドラーを設定

- `sendCrowdingNotification(boothName, visitorCount)`: 混雑警報通知を送信
- `setCrowdingThreshold(threshold)`: 混雑度閾値を設定
- `clearAllNotifications()`: 全通知をクリア

---

### 5. screens/home_screen.dart

#### 役割
ビーコンの検出と受信状況を表示する画面。

#### 主要変数

**_HomeScreenState**
- `_deviceNames` (Map<String, DateTime>): 現在受信中のビーコン名と検出時刻
- `_firebaseService` (FirebaseService): Firebaseサービスインスタンス
- `_authService` (AuthService): 認証サービスインスタンス
- `_todayStats` (Map<String, dynamic>): 今日の統計データ
- `_isLoading` (bool): データ読み込み中フラグ
- `_userName` (String): 現在のユーザー名
- `_countedToday` (Set<String>): 今日カウント済みのデバイス名（重複防止）

#### 主要メソッド
- `startScan()`: BLEビーコンのスキャンを開始
  - 3秒間スキャン → 停止 → 再開（ループ）
  - 検出されたビーコン名を`_deviceNames`に記録
  - 初回検出時のみ`incrementBeaconCount()`を呼び出し

- `loadTodayStats()`: 今日の統計データをFirebaseから取得

---

### 6. screens/organizer_screen.dart

#### 役割
主催者向けの統計分析画面。6つのタブで様々な分析を表示。

#### 主要変数

**_OrganizerScreenState**
- `_authService` (AuthService): 認証サービス
- `_firebaseService` (FirebaseService): Firebaseサービス
- `_todayStats` (Map<String, dynamic>): 今日の統計データ
- `_visitorData` (List<Map<String, dynamic>>): 来場者データ一覧
- `_companyAttributeStats` (Map<String, dynamic>): 企業属性統計
- `_boothStayTimeStats` (Map<String, double>): ブース別滞在時間統計
- `_movementPatterns` (List<Map<String, dynamic>>): 移動パターン
- `_rssiThresholds` (Map<String, int>): ビーコンごとのRSSI閾値
- `_selectedTabIndex` (int): 現在選択中のタブインデックス
- `_tabController` (TabController): タブコントローラー

#### タブ構成
1. **ヒートマップ**: 会場全体の混雑状況を可視化
2. **年齢・性別**: 年齢分布と性別分布を円グラフ・棒グラフで表示
3. **企業属性**: 業種、役職、職業の分布を表示
4. **興味分野**: 来場者の興味のある分野を棒グラフで表示
5. **行動データ**: 滞在時間、移動パターン、訪問回数を分析
6. **設定**: RSSI閾値の設定

#### 主要メソッド
- `_loadData()`: 全データを読み込み
- `_getGenderDistribution()`: 性別分布を計算
- `_getAgeDistribution()`: 年齢分布を計算（10代、20代...に分類）
- `_setBeaconRssiThreshold(beaconName, threshold)`: RSSI閾値を設定

---

### 7. screens/staff_screen.dart

#### 役割
スタッフ向けの混雑監視画面。ヒートマップと混雑警報を表示。

#### 主要変数

**_StaffScreenState**
- `_authService` (AuthService): 認証サービス
- `_firebaseService` (FirebaseService): Firebaseサービス
- `_notificationService` (NotificationService): 通知サービス
- `_todayStats` (Map<String, dynamic>): 今日の統計データ
- `_beaconLocations` (List<BeaconLocation>): ビーコンの位置情報
- `_showHeatmap` (bool): ヒートマップ表示フラグ
- `_crowdingThreshold` (int): 混雑度閾値（デフォルト25人）
- `_eventLayout` (Map<String, dynamic>?): イベントレイアウト情報
- `_mapElements` (List<Map<String, dynamic>>): マップ要素（壁、通路など）
- `_crowdingAlerts` (Map<String, bool>): 混雑警報状態（ブースID → 混雑中かどうか）
- `_monitoringTimer` (Timer?): 混雑監視用のタイマー

#### 主要メソッド
- `_loadData()`: データとマップレイアウトを読み込み
- `_loadMapLayout()`: Firebaseからマップレイアウトを取得
- `_startCrowdingMonitoring()`: 30秒ごとに混雑度をチェックするタイマーを開始
- `_checkCrowdingLevels()`: 各ブースの混雑度をチェックし、閾値を超えた場合に通知を送信
- `_getCrowdColor(count)`: 混雑度に応じた色を返す
  - 0人: 青
  - 1-5人: 緑
  - 6-15人: 黄
  - 16-30人: 橙
  - 31人以上: 赤

#### 混雑監視の動作
1. 30秒ごとに`_checkCrowdingLevels()`が実行される
2. 各ブースの現在人数を`_todayStats`から取得
3. 閾値（`_crowdingThreshold`）を超えているかチェック
4. 新しく混雑になった場合、`NotificationService.sendCrowdingNotification()`を呼び出し
5. `_crowdingAlerts`を更新してUIに反映

---

### 8. screens/login_screen.dart

#### 役割
ユーザーログイン画面。

#### 主要変数

**_LoginScreenState**
- `_formKey` (GlobalKey<FormState>): フォームのバリデーション用キー
- `_idController` (TextEditingController): ID入力コントローラー
- `_passwordController` (TextEditingController): パスワード入力コントローラー
- `_authService` (AuthService): 認証サービス
- `_selectedRole` (UserRole): 選択中のロール（デフォルト: exhibitor）
- `_isLoading` (bool): ログイン処理中フラグ
- `_obscurePassword` (bool): パスワード表示/非表示フラグ

#### 主要メソッド
- `_login()`: ログイン処理を実行
  - 選択されたロールに応じて適切なログインメソッドを呼び出し
  - 成功時は`_navigateToHome()`で画面遷移

- `_navigateToHome()`: ログイン成功後の画面遷移
  - ロールに応じて適切な画面に遷移
  - Webの主催者は`WebDashboardScreen`に遷移

---

## データフロー

### ビーコン検出からデータ保存までの流れ

1. **ビーコン検出** (`home_screen.dart`)
   - `startScan()`でBLEスキャンを開始
   - `FlutterBluePlus.scanResults`でビーコンを検出
   - ビーコン名（例: "FSC-BP104D"）を取得

2. **重複チェック** (`firebase_service.dart`)
   - `_lastProcessedUserBeacon`で5秒以内の重複をチェック
   - 重複の場合は処理をスキップ

3. **データ保存** (`firebase_service.dart`)
   - `incrementBeaconCount()`を呼び出し
   - 来場者属性情報を取得（`getVisitorData()`）
   - Firestoreの`beacon_counts/{日付}/devices/{デバイス名}`に保存
   - `count`をインクリメント
   - `visitors`配列に来場者データを追加

4. **統計更新** (`organizer_screen.dart`, `staff_screen.dart`)
   - `getTodayStats()`で最新の統計を取得
   - UIに反映

### 混雑警報の流れ

1. **定期チェック** (`staff_screen.dart`)
   - `_monitoringTimer`が30秒ごとに`_checkCrowdingLevels()`を実行

2. **混雑度判定**
   - 各ブースの現在人数を`_todayStats`から取得
   - `_crowdingThreshold`と比較

3. **通知送信**
   - 閾値を超え、かつ前回チェック時は混雑でなかった場合
   - `NotificationService.sendCrowdingNotification()`を呼び出し
   - ローカル通知を表示

---

## 主要機能の動作説明

### 1. ビーコン検出とカウント

**目的**: 来場者がブースに近づいたことを検出し、訪問数をカウント

**動作**:
1. `HomeScreen`でBLEスキャンを開始（3秒間隔でループ）
2. ビーコン名を取得（例: "FSC-BP104D"）
3. 初回検出時のみ`FirebaseService.incrementBeaconCount()`を呼び出し
4. 重複チェック（5秒以内の同一ユーザー・同一ビーコンはスキップ）
5. Firestoreに保存:
   - `count`をインクリメント
   - `visitors`配列に来場者データを追加
   - `lastSeen`を更新

### 2. 混雑監視と警報

**目的**: ブースの混雑状況を監視し、閾値を超えた場合に通知

**動作**:
1. `StaffScreen`で30秒ごとに`_checkCrowdingLevels()`を実行
2. 各ブースの現在人数を`_todayStats`から取得
3. `_crowdingThreshold`（デフォルト25人）と比較
4. 閾値を超え、かつ前回は混雑でなかった場合:
   - `NotificationService.sendCrowdingNotification()`を呼び出し
   - ローカル通知を表示（例: "ブースAが混雑しています（現在30人）"）
5. `_crowdingAlerts`を更新してUIに反映（赤枠で表示）

### 3. RSSI閾値による検出範囲調整

**目的**: ビーコンの検出範囲を調整して、ブースから離れた位置での誤検出を防ぐ

**動作**:
1. `OrganizerScreen`の設定タブでRSSI閾値を設定
2. `FirebaseService.setBeaconRssiThreshold()`でFirestoreに保存
3. ビーコン検出時にRSSI値を取得
4. RSSI値が閾値以下の場合、検出を無視（ブースから遠すぎると判断）

**推奨値**:
- `-92 dBm`: ブースの角（2.12m）をカバー（デフォルト）
- `-86 dBm`: 1.5m以内をカバー
- `-78 dBm`: 1.0m以内をカバー
- `-70 dBm`: 0.5m以内をカバー

### 4. 行動データ分析

**目的**: 来場者の滞在時間、移動パターン、訪問回数を分析

**データ取得**:
- `getBoothStayTimeStats()`: ブース別平均滞在時間
- `getMovementPatterns()`: よくある移動パターン（TOP5）
- `getAllVisitors()`: 来場者ごとの訪問回数、総滞在時間

**表示**:
- `OrganizerScreen`の「行動データ」タブで表示
- 棒グラフでブース別滞在時間を可視化
- リストで移動パターンを表示（例: "ブースA → ブースB: 15人"）

### 5. 巡回ルート最適化

**目的**: お気に入りブースを効率的に回る順序を計算

**動作**:
1. ユーザーがお気に入りブースを選択
2. `FirebaseService.computeOptimalRoute()`を呼び出し
3. 現在位置と各ブースの座標を取得
4. TSP（巡回セールスマン問題）を解く:
   - 8件以下: 全探索で最適解
   - 9件以上: 近傍挿入法 + 2-optで準最適解
5. 最短距離で回る順序を返す

---

## データベース構造

詳細は`Cloud_Firestore_データベース構造.md`を参照。

### 主要コレクション
- `beacon_counts/{日付}/devices/{デバイス名}`: ビーコン検出データ
- `visitors/{visitorId}`: 来場者属性情報
- `booths/{boothId}`: ブース情報
- `event_layouts/{eventId}`: 展示会レイアウト
- `map_elements/{elementId}`: マップ要素（壁、通路など）
- `system_settings/rssi_thresholds`: RSSI閾値設定
- `organizers/{organizerId}`: 主催者認証情報
- `staff/{staffId}`: スタッフ認証情報
- `exhibitors/{exhibitorId}`: 出展者認証情報

---

## 注意事項

### 重複検出防止
- 同一ユーザーが同一ビーコンに5秒以内にアクセスした場合、カウントをスキップ
- `_lastProcessedUserBeacon`で管理

### パフォーマンス
- TSPの全探索は8件以下に制限
- 統計データは必要に応じてキャッシュを検討

### セキュリティ
- 認証情報はFirestoreに平文で保存（本番環境では暗号化を推奨）
- 来場者ログインは認証不要（簡易版）

---

## 更新履歴

- 2025-01-XX: 初版作成

